name: Prepare Release

on:
  workflow_dispatch:
    inputs:
      bump:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major

jobs:
  prepare:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.RELEASE_PAT }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Bump version with npm
        id: version
        run: |
          # Use npm to bump version (updates package.json and package-lock.json)
          NEW_VERSION=$(npm version ${{ github.event.inputs.bump }} --no-git-tag-version)
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "Bumped to $NEW_VERSION"

      - name: Get release date
        id: date
        run: echo "date=$(date -u +%Y-%m-%d)" >> $GITHUB_OUTPUT

      - name: Run Claude Code to update changelog and create PR
        uses: anthropics/claude-code-action@v1
        env:
          NEW_VERSION: ${{ steps.version.outputs.new_version }}
          RELEASE_DATE: ${{ steps.date.outputs.date }}
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          allowed_tools: |
            Bash(git:*)
            Bash(gh pr create:*)
            Edit
            Read
            Write
            Glob
          direct_prompt: |
            You are preparing a release for this package. The version has already been bumped to ${{ steps.version.outputs.new_version }} in package.json and package-lock.json.

            ## 1. Update .claude-plugin/plugin.json
            Update the "version" field to match the new version (without the 'v' prefix).
            For example, if NEW_VERSION is "v0.3.0", set version to "0.3.0".

            ## 2. Update CHANGELOG.md
            - Get the list of commits since the last tag: `git log $(git describe --tags --abbrev=0)..HEAD --oneline`
            - Read the current CHANGELOG.md
            - Add a new section at the top (after the header) for the new version
            - Use this exact date: ${{ steps.date.outputs.date }}
            - Follow the Keep a Changelog format with Added/Changed/Fixed sections as appropriate
            - IMPORTANT: Editorialize the commit messages for the audience (library consumers)
              - Write in terms of what changed for users, not what contributors did
              - Skip internal/chore commits unless they affect users
              - Be concise - one line per meaningful change
              - Group related changes together

            ## 3. Create a release branch and PR
            - Configure git:
              ```
              git config user.name "github-actions[bot]"
              git config user.email "github-actions[bot]@users.noreply.github.com"
              ```
            - Create a new branch named `release/${{ steps.version.outputs.new_version }}`
            - Stage and commit all changes with message "Bump version to ${{ steps.version.outputs.new_version }}"
            - Push the branch
            - Create a PR with title exactly: "Release ${{ steps.version.outputs.new_version }}"
            - Include the changelog section you wrote in the PR body

            ## Important notes
            - Do NOT create or push any git tags
            - The PR title MUST start with "Release v" exactly - this triggers the tagging workflow on merge
